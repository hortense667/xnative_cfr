# xnative_cfr（ネイティブマップ診断）

## 概要

自分が生まれて何歳の頃に何に出会ったかをチェックしていくことで、AIによる分析を行うシステムです。年表データごとにAIの分析方法が異なっています。何年のときに自分は何歳だったか分かるようになっていて、Wikipediaなどの関連ページも容易に見ることができます。当時の状況を思い浮かべたり確認しながらチェックしていき、楽しみながら自分の人生を俯瞰しながらチェックしていってください。自分の生まれる前の事柄もあるので年を示すプローブの〇は、生年よりも前に動かすこともできます。項目がバランスよくチェックされたか確認したら「診断」へ進んでください。生年と性別、チェック項目を集計、他の人たちのチェック内容との比較や分析も行います（現時点では未実装）。それにより、たとえば日本のコンテンツ消費者（広い意味でのオタク）を64分類するといったことを目指しています。

---

年表ベースの診断アプリです。タイムライン上のコンテンツ・イベントを選び、AI（Gemini / OpenAI）による診断結果を得られます。キオスクモード（イベント会場向け）と通常表示の両方に対応しています。

---

## 概要

- **メインHTML:** `xnative_cfr_r050.html`
- **サーバー:** Node + Express（`server.js`）— 静的配信・診断API・診断結果の蓄積
- **設定:** `cfr_prompts.json` で年表ごとのタイトル・説明・AIプロンプトを切り替え
- **URL:** `?filePath=タイムラインJSON名` で年表を指定可能。`editmode=ON` を付けるとヘッダに「設定」ボタンが表示され、設定画面（GitHub同期設定など）を開ける。

---

## 画面の流れ

### 1. 起動〜診断開始（キオスクモード）

1. **開始オーバーレイ（ステップ1）**  
   タイトル・説明を表示。「次へ」で進む。
2. **属性入力（ステップ2）**  
   性別（男・女・答えない）とニックネーム（最大16文字）を入力。「次へ」で進む。
3. **診断スタート（ステップ3）**  
   注意事項と地球マークの説明を表示。「診断スタート」でオーバーレイを閉じ、本編へ。

### 2. 診断フロー本編

4. **ステップ1：ジャンルを選ぶ**  
   ジャンル選択モーダルで関心のあるジャンルを1つ以上選び「適用」で次へ。
5. **ステップ2：生年をセット**  
   青いプローブの**上の〇**（青い斜め線の左上付近）をドラッグし、左の年表の自分の生まれ年に合わせる。スクロールで遡れる。
6. **ステップ3：イベントをチェック**  
   - **下の〇**（青い横線の左端付近）をドラッグして年を変えると、その年のイベント一覧が表示される。  
   - 一覧のチェックボックスで「好きだった／影響を受けた」コンテンツを選ぶ。**10個以上**選ぶと「診断」ボタンが有効になる。  
   - **スマホ時:** 「診断」の右に **チェック数（X/10）** と **▼年＋**／**▲年－** ボタンでチェックする年を変えられる。押すとその年の一覧が表示され、下の〇がヘッダの下に来るようスクロールする。
7. **診断実行**  
   「診断」を押すと選択内容のサマリが表示され、続けてAI診断を実行。結果表示後「次へ」で総合結果へ（設定により2回目AIの推薦文を表示）。最後に「使いかた」画面またはスタートへ戻る。

### 3. 通常利用（年表のみ・編集）

- **プローブ:** 青いラインの**上の〇**＝イベント年、**下の〇**＝生年。ドラッグで年を変えられる。
- **検索:** 検索欄にラベル（作品名など）を入力し「検索」でヒット。ヒット時に**下の〇（イベント年）**がその年にセットされ、スマホでは下の〇がヘッダの下に来るようスクロールする。「前」「次」で別のヒットに移動可能。スマホでは **▼年＋** と **▲年－** ボタンでチェックする年を変えていくこともできる。
- **フィルタ:** 「ジャンル」でフィルタリングして表示。
- **ウェブプレビュー（地球マーク 🌐）:**  
  - **PC:** 地球マークにホバーで関連ページ（Wikipedia等）を右側にプレビュー表示。  
  - **スマホ:** 地球マークをタップするとプレビューを画面の中央に大きく表示。画面の他の部分をタップすると閉じる。
- **編集:** 左カラムの年行をクリックでラベル編集など（トークン設定時）。

---

## 技術メモ

- **診断API:** フロントは `cfr_prompts.json` の `aiProvider` に応じて `/api/gemini-diagnosis` または `/api/openai-diagnosis` を呼ぶ。サーバーは失敗時に他方へフォールバック可能。
- **蓄積:** 診断完了時に `POST /api/diagnostic-result` で生年・性別・ニックネーム・チェックしたイベント（年・イベント名・ジャンル等）を送信。`GET /api/diagnostic-results` で一覧取得可能。
- **デプロイ:** Railway 向け手順は `RAILWAY_DEPLOY.md` を参照。APIキーは環境変数のみ（`GEMINI_API_KEY` / `OPENAI_API_KEY`）。蓄積の永続化は Volume + `DATA_DIR` を推奨。

---

## ファイル構成

| ファイル | 説明 |
|----------|------|
| `xnative_cfr_r050.html` | メイン画面（年表・プローブ・診断フロー・ヘルプ） |
| `server.js` | 静的配信・診断API・蓄積API |
| `cfr_prompts.json` | 年表別タイトル・説明・AIプロンプト |
| `RAILWAY_DEPLOY.md` | Railway デプロイ手順 |
| `package.json` | Node 依存・起動スクリプト |

---

## ライセンス・クレジット

(c) 2026 Satoshi Endo  
The timeline data for Xnative/Timeline is published under CC BY-SA 4.0.
